const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
let dots = [];
let emojis = []; 
const emojiList = ['âœ¨', 'â­', 'ğŸŒ ', 'ğŸŒ¸', 'ğŸ”¥', 'ğŸ’'];

// ç”¨äºæ‰‹åŠ¿æ£€æµ‹çš„å˜é‡
let touchStartTime = 0;
let startX = 0;
let startY = 0;

function resize() {
    canvas.width = window.innerWidth * window.devicePixelRatio;
    canvas.height = window.innerHeight * window.devicePixelRatio;
    ctx.scale(window.devicePixelRatio, window.devicePixelRatio);
}

// æ™®é€šäº¤äº’ç²’å­
class Dot {
    constructor(x, y, color) {
        this.x = x;
        this.y = y;
        this.v = { x: (Math.random() - 0.5) * 4, y: (Math.random() - 0.5) * 4 };
        this.radius = 15;
        this.color = color;
        this.alpha = 1;
    }
    draw() {
        ctx.save();
        ctx.beginPath();
        ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);
        ctx.fillStyle = `hsla(${this.color}, 100%, 50%, ${this.alpha})`;
        ctx.fill();
        ctx.restore();
    }
    update() {
        this.x += this.v.x;
        this.y += this.v.y;
        this.alpha -= 0.015;
        this.radius *= 0.98;
    }
}

// --- ä¼˜åŒ–åçš„ Emoji ç²’å­ç±» ---
class EmojiParticle {
    constructor(x, y, angle) {
        this.x = x;
        this.y = y;
        this.char = emojiList[Math.floor(Math.random() * emojiList.length)];
        this.size = Math.random() * 20 + 20;
        
        // åŸºäºåˆ’åŠ¨è§’åº¦ç”Ÿæˆé€Ÿåº¦ï¼Œå¢åŠ ä¸€å®šçš„éšæœºåç§»ï¼Œå½¢æˆæ‰‡å½¢å–·å°„
        const spread = (Math.random() - 0.5) * 1.5; // æ‰©æ•£èŒƒå›´
        const speed = Math.random() * 15 + 5;
        this.vx = Math.cos(angle + spread) * speed;
        this.vy = Math.sin(angle + spread) * speed;
        
        this.alpha = 1;
        this.rotation = Math.random() * Math.PI * 2;
    }
    draw() {
        ctx.save();
        ctx.globalAlpha = this.alpha;
        ctx.font = `${this.size}px serif`;
        ctx.translate(this.x, this.y);
        ctx.rotate(this.rotation);
        ctx.fillText(this.char, -this.size/2, this.size/2);
        ctx.restore();
    }
    update() {
        this.x += this.vx;
        this.y += this.vy;
        this.vy += 0.2; // æ¨¡æ‹Ÿé‡åŠ›
        this.alpha -= 0.01;
        this.rotation += 0.1;
    }
}

function handleTouchStart(e) {
    const touch = e.touches[0];
    startX = touch.clientX;
    startY = touch.clientY;
    touchStartTime = Date.now();
}

function handleTouchMove(e) {
    e.preventDefault();
    for (let i = 0; i < e.touches.length; i++) {
        const touch = e.touches[i];
        const touchHue = (touch.identifier * 40) % 360;
        for (let j = 0; j < 2; j++) {
            dots.push(new Dot(touch.clientX, touch.clientY, touchHue));
        }
    }
}

function handleTouchEnd(e) {
    const touch = e.changedTouches[0];
    const dx = touch.clientX - startX;
    const dy = touch.clientY - startY;
    const duration = Date.now() - touchStartTime;

    // è®¡ç®—åˆ’åŠ¨çš„æ¬§å‡ é‡Œå¾—è·ç¦»
    const distance = Math.sqrt(dx * dx + dy * dy);

    // åˆ¤æ–­æ¡ä»¶ï¼šè·ç¦»è¶…è¿‡ 80 åƒç´ ï¼Œä¸”æ—¶é—´çŸ­äº 300msï¼ˆå³å¿«åˆ’ï¼‰
    if (distance > 80 && duration < 300) {
        // è®¡ç®—åˆ’åŠ¨çš„è§’åº¦ (å¼§åº¦)
        const angle = Math.atan2(dy, dx);
        triggerEmojiStorm(touch.clientX, touch.clientY, angle);
    }
}

function triggerEmojiStorm(x, y, angle) {
    for (let i = 0; i < 40; i++) {
        // å°†åˆ’åŠ¨è§’åº¦ä¼ å…¥ï¼Œè®©ç²’å­æ²¿åˆ’åŠ¨æ–¹å‘é£å‡º
        emojis.push(new EmojiParticle(x, y, angle));
    }
}

function loop() {
    ctx.fillStyle = 'rgba(0, 0, 0, 0.15)';
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    
    dots = dots.filter(d => d.alpha > 0);
    dots.forEach(d => {
        d.update();
        d.draw();
    });

    emojis = emojis.filter(e => e.alpha > 0);
    emojis.forEach(e => {
        e.update();
        e.draw();
    });

    requestAnimationFrame(loop);
}

window.addEventListener('touchstart', handleTouchStart, {passive: false});
window.addEventListener('touchmove', handleTouchMove, {passive: false});
window.addEventListener('touchend', handleTouchEnd);
window.addEventListener('resize', resize);

resize();
loop();
