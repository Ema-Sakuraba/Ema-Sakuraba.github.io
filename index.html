<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Sakurabaema Cosmic Exp</title>
    <style>
        body { margin: 0; overflow: hidden; background: #000; touch-action: none; }
        canvas { display: block; width: 100vw; height: 100vh; }
    </style>
</head>
<body>
    <canvas id="canvas"></canvas>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        
        let dots = [];
        let emojis = [];
        const emojiList = ['ğŸŒ¸', 'âœ¨', 'â­', 'ğŸŒ '];
        
        // è¿›åº¦æ§åˆ¶
        let skyProgress = 0; // 0 åˆ° 100
        let autoMeteorTimer = 0;

        let touchStart = { x: 0, y: 0, time: 0 };

        function resize() {
            canvas.width = window.innerWidth * window.devicePixelRatio;
            canvas.height = window.innerHeight * window.devicePixelRatio;
            ctx.scale(window.devicePixelRatio, window.devicePixelRatio);
        }

        class Dot {
            constructor(x, y, color) {
                this.x = x; this.y = y;
                this.v = { x: (Math.random() - 0.5) * 3, y: (Math.random() - 0.5) * 3 };
                this.radius = 12;
                this.color = color;
                this.alpha = 1;
            }
            update() {
                this.x += this.v.x; this.y += this.v.y;
                this.alpha -= 0.02;
                this.radius *= 0.96;
            }
            draw() {
                ctx.fillStyle = `hsla(${this.color}, 100%, 60%, ${this.alpha})`;
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);
                ctx.fill();
            }
        }

        class Meteor {
            constructor(isAuto = false) {
                // å±å¹•ä¼˜åŒ–ï¼šä»å³ä¸Šæ–¹æ‰‡åŒºéšæœºç”Ÿæˆ
                this.x = Math.random() * window.innerWidth + (window.innerWidth / 3);
                this.y = -20;
                this.char = emojiList[Math.floor(Math.random() * emojiList.length)];
                this.size = isAuto ? 15 : 22; // è‡ªåŠ¨è½ä¸‹çš„æµæ˜Ÿç¨å°ï¼Œæ›´ç²¾è‡´
                this.vx = -(Math.random() * 5 + 6); 
                this.vy = (Math.random() * 5 + 5);
                this.alpha = 1;
            }
            update() {
                this.x += this.vx;
                this.y += this.vy;
                if (this.x < -50 || this.y > window.innerHeight + 50) this.alpha = 0;
            }
            draw() {
                ctx.save();
                ctx.globalAlpha = this.alpha;
                ctx.font = `${this.size}px serif`;
                ctx.fillText(this.char, this.x, this.y);
                ctx.restore();
            }
        }

        function triggerStorm(count) {
            for (let i = 0; i < count; i++) {
                setTimeout(() => emojis.push(new Meteor()), i * 50);
            }
        }

        window.addEventListener('touchstart', (e) => {
            touchStart = { x: e.touches[0].clientX, y: e.touches[0].clientY, time: Date.now() };
        });

        window.addEventListener('touchmove', (e) => {
            e.preventDefault();
            const touch = e.touches[0];
            const hue = (touch.identifier * 50) % 360;
            
            // æ€§èƒ½ä¼˜åŒ–ï¼šé™åˆ¶æ™®é€šç²’å­äº§ç”Ÿé¢‘ç‡
            if (dots.length < 100) {
                dots.push(new Dot(touch.clientX, touch.clientY, hue));
            }

            // åˆ’åŠ¨å¢åŠ èƒŒæ™¯è¿›åº¦
            if (skyProgress < 100) skyProgress += 0.1;
        }, {passive: false});

        window.addEventListener('touchend', (e) => {
            const touch = e.changedTouches[0];
            const dx = touch.clientX - touchStart.x;
            const dy = touch.clientY - touchStart.y;
            const duration = Date.now() - touchStart.time;

            if (dx < -60 && dy > 60 && duration < 250) {
                triggerStorm(20); // å‡å°‘å•æ¬¡æ•°é‡è‡³20ï¼Œé˜²å¡é¡¿
            }
        });

        function loop() {
            // èƒŒæ™¯éšè¿›åº¦ç”±é»‘å˜æ·±è“
            const blueValue = Math.floor((skyProgress / 100) * 20); // æœ€å¤§æ·±è“å€¼
            ctx.fillStyle = `rgba(0, 0, ${blueValue}, 0.2)`;
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // è‡ªåŠ¨æµæ˜Ÿé€»è¾‘
            if (skyProgress > 80) {
                autoMeteorTimer++;
                if (autoMeteorTimer > 120) { // çº¦æ¯2ç§’ä¸€é¢—
                    emojis.push(new Meteor(true));
                    autoMeteorTimer = 0;
                }
            }

            // é™åˆ¶æ•°ç»„é•¿åº¦ï¼ŒåŒé‡ä¿é™©é˜²å¡é¡¿
            if (dots.length > 150) dots.shift();

            dots = dots.filter(d => d.alpha > 0);
            dots.forEach(d => { d.update(); d.draw(); });

            emojis = emojis.filter(e => e.alpha > 0);
            emojis.forEach(e => { e.update(); e.draw(); });

            requestAnimationFrame(loop);
        }

        window.addEventListener('resize', resize);
        resize();
        loop();
    </script>
</body>
</html>
